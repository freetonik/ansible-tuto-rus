Пособие по Vagrant
================

Плейбуки Ansible
-----------------

Концепция плейбуков очень проста: это просто набор Ansible-команд (задач, tasks), похожих на те, что мы выполняли с утилитой `ansible`. Эти задачи направлены на конкретные наборы узлов/групп.

Необходиые для этого шага файлы должны были возникнуть магическим образом, так что вам не нужно ничего набирать.

# Пример с Apache (a.k.a. "Hello World!" в Ansible')

Продолжаем с допущением, что ваш inventory-файл выглядит так (назовем его `hosts`):

    [web]
    host1.example.org

и все хосты это системы на основе Debian.

Заметка: помните, что вы можете (и в нашем упражнении мы делаем это) использовать `ansible_ssh_host` чтобы задать реальный IP-адрес хоста. Вы также можете изменять inventory и использовать реальный hostname. В любом случае, используйте машину, с которой безопасно экспериментировать. На реальных хостах мы также добавляем `ansible_ssh_user=root` чтобы избежать потенциальных проблем с разными конфигурациями по умолчанию.

Давайте соберем плейбук, который установит Apache на машины группы `web`.

    - hosts: web
      tasks:
        - name: Installs apache web server
          apt: pkg=apache2 state=installed update_cache=true

Нам всего лишь нужно сказать что мы хотим сделать используя правильные модули Ansible. Здесь мы используем модуль [apt](http://ansible.cc/docs/modules.html#apt), который может устанавливать Debian-пакеты. Мы также просим этот подуль обновить кэш.

Нам нужно имя для этой задачи. Это не обязательно, но желательно для вашего же удобства.

Ну, в целом было довольно легко!

Теперь можно запустить плейбук (назовем его `apache.yml`):

    ansible-playbook -i step-04/hosts -l host1.example.org step-04/apache.yml

Здесь `step-04/hosts` это inventory-файл, `-l` ограничивает запуск хостом `host1.example.org`,
и `apache.yml` это наш плейбук.

При запуске команды будет вывод подобный этому:

    PLAY [web] ********************* 

    GATHERING FACTS ********************* 
    ok: [host1.example.org]

    TASK: [Installs apache web server] ********************* 
    changed: [host1.example.org]

    PLAY RECAP ********************* 
    host1.example.org              : ok=2    changed=1    unreachable=0    failed=0    

Заметка: возможно, вы заметите корову, если у вас установлен `cowsay`. Если она вам не нравится, можно отключить ее так: `export ANSIBLE_NOCOWS="1"`.

Давайте проанализируем вывод строчка за строчкой.

    PLAY [web] ********************* 
    
Ansible говорит нам, что play выполняется в группе `web`. Play это набор инструкций Ansible, связанных с хостом. Если бы у нас был другой `-host: blah` в плейбуке, он бы тоже вывелось (но после того, как первый play завершен).

    GATHERING FACTS ********************* 
    ok: [host1.example.org]

Помните, когда мы использовали модуль `setup`? Перед каждым play'ем Ansible запускает его на каждом хосте и собирает факты. Если этого не нужно делать потому что вам не нужна никакая информация о хосте, можно добавить `gather_facts: no` под строкой хоста (на том же уровне что `tasks:`).

    TASK: [Installs apache web server] ********************* 
    changed: [host1.example.org]

Теперь самое главное: наша первая и единственная задача запущена, и так как там сказано `changed`, мы знаем что она изменила что-то на хосте `host1.example.org`.

    PLAY RECAP ********************* 
    host1.example.org              : ok=2    changed=1    unreachable=0    failed=0 

Наконец, Ansible выводит резюме того, что произошло: две задачи были выполнены и одна из них изменила что-то на хосте (это была наша задача apache; модуль setup ничего не меняяет).

Давайте запустим это еще раз и посмотрим, что произойдет:

    $ ansible-playbook -i step-04/hosts -l host1.example.org step-04/apache.yml

    PLAY [web] ********************* 

    GATHERING FACTS ********************* 
    ok: [host1.example.org]

    TASK: [Installs apache web server] ********************* 
    ok: [host1.example.org]

    PLAY RECAP ********************* 
    host1.example.org              : ok=2    changed=0    unreachable=0    failed=0    

Теперь changed равен '0'. Это совершенно нормально и является одной из главных особенностей Ansible: плейбук будет делать что-то только если есть что делать. Это называется _идемпотентностью_. Это значит что можно запускать плейбук сколько угодно раз, но в итоге мы будем иметь машину в одном и том же состоянии (ну, только если вы не будете делать безумных штук с модулем `shell`, но Ansible уже не сможет ничего поделать).

Переходите к следующему шагу [step-05](https://github.com/freetonik/ansible-tuto-rus/tree/master/step-05).
